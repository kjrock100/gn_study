# Chromium GN Action Foreach 타겟 가이드

`action_foreach` 타겟은 `sources` 리스트에 있는 **각 파일마다** 스크립트를 한 번씩 실행해야 할 때 사용합니다. IDL 컴파일, 이미지 변환 등 1:1 파일 처리에 최적화되어 있습니다.

## 1. 기본 구조 (Basic Structure)

```gn
action_foreach("compile_idls") {
  script = "tools/idl_compiler.py"
  
  sources = [ "foo.idl", "bar.idl" ]
  
  # 출력 파일 경로 패턴 (치환 패턴 사용 필수)
  outputs = [ "$target_gen_dir/{{source_name_part}}.h" ]

  # 스크립트 인자 (치환 패턴 사용)
  args = [
    "{{source}}",
    "--output", rebase_path("$target_gen_dir/{{source_name_part}}.h", root_build_dir),
  ]
}
```

## 2. 주요 변수 (Key Variables)

### `script` (필수)
실행할 스크립트 파일의 경로입니다.

### `sources` (필수)
스크립트가 반복 실행될 대상 파일 목록입니다. 이 리스트의 항목 수만큼 스크립트가 실행됩니다.

### `outputs` (필수)
각 소스 파일에 대해 생성될 출력 파일의 목록입니다.
*   **중요**: 반드시 **치환 패턴(Substitution Patterns)**을 포함해야 합니다. 그렇지 않으면 모든 실행이 같은 출력 파일을 덮어쓰게 되므로 에러가 발생합니다.

### `args`
스크립트에 전달할 인자입니다. 현재 처리 중인 소스 파일 정보를 전달하기 위해 치환 패턴을 사용합니다.

### `inputs`
모든 스크립트 실행에 공통적으로 필요한 의존성 파일입니다. (예: 스크립트가 사용하는 설정 파일)

## 3. 치환 패턴 (Substitutions)

`outputs`와 `args`에서 현재 처리 중인 소스 파일에 대한 정보를 참조하기 위해 사용합니다.

*   `{{source}}`: 현재 처리 중인 소스 파일의 전체 경로 (예: `//foo/bar.idl`).
*   `{{source_name_part}}`: 확장자를 제외한 파일 이름 (예: `bar`).
*   `{{source_file_part}}`: 파일 이름 (예: `bar.idl`).
*   `{{source_dir}}`: 소스 파일이 있는 디렉토리 (예: `//foo`).
*   `{{source_out_dir}}`: 소스 파일 디렉토리에 대응하는 출력 디렉토리.
*   `{{source_gen_dir}}`: 소스 파일 디렉토리에 대응하는 생성 파일 디렉토리.

## 4. `action` vs `action_foreach`

*   **`action`**: 스크립트가 **한 번만** 실행됩니다. `sources`는 단순히 의존성(입력 변경 감지용)으로만 작용하거나, 스크립트가 리스트 전체를 한꺼번에 처리할 때 사용합니다.
*   **`action_foreach`**: 스크립트가 `sources`의 **개수만큼** 실행됩니다. 각 실행은 독립적이며 병렬로 처리될 수 있습니다.

## 5. 예제: 텍스트 파일을 헤더로 변환

```gn
action_foreach("text_to_header") {
  script = "tools/txt2h.py"
  
  sources = [
    "message_en.txt",
    "message_ko.txt",
  ]
  
  # 예: message_en.txt -> gen/message_en.h
  outputs = [ "$target_gen_dir/{{source_name_part}}.h" ]

  args = [
    "--input", "{{source}}",
    # rebase_path와 치환 패턴을 함께 사용
    "--output", rebase_path("$target_gen_dir/{{source_name_part}}.h", root_build_dir),
  ]
}
```
