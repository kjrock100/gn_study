# Chromium GN Analyze 가이드

`gn analyze`는 소스 코드 변경 사항이 주어졌을 때, 어떤 타겟을 다시 빌드해야 하고 어떤 테스트를 실행해야 하는지 식별하는 명령어입니다. 주로 CI(Continuous Integration) 시스템에서 빌드 및 테스트 시간을 최적화하기 위해 사용됩니다.

## 1. 명령어 사용법 (Usage)

```bash
gn analyze <out_dir> <input_json> <output_json>
```

*   **`<out_dir>`**: 빌드 디렉토리 경로 (예: `out/Default`).
*   **`<input_json>`**: 분석할 입력 데이터가 담긴 JSON 파일 경로.
*   **`<output_json>`**: 분석 결과를 저장할 JSON 파일 경로.

## 2. 입력 형식 (Input Format)

입력 JSON 파일은 다음과 같은 필드를 가집니다.

```json
{
  "files": [
    "//base/logging.cc",
    "//chrome/browser/ui/browser.h"
  ],
  "test_targets": [
    "//base:base_unittests",
    "//chrome/test:browser_tests"
  ],
  "additional_compile_targets": [
    "//chrome:chrome"
  ]
}
```

*   **`files`**: 변경된 파일들의 목록입니다. 소스 루트(`//`)로 시작하는 경로를 사용합니다.
*   **`test_targets`**: 실행 후보가 되는 테스트 타겟 라벨 목록입니다. GN은 변경된 파일이 이 타겟들에 영향을 주는지 분석합니다.
*   **`additional_compile_targets`**: (선택 사항) 테스트는 아니지만 컴파일이 필요한지 확인하고 싶은 타겟 목록입니다.

## 3. 출력 형식 (Output Format)

GN은 분석 결과를 다음과 같은 JSON 형식으로 출력합니다.

```json
{
  "status": "Found dependency",
  "compile_targets": [ "//base:base_unittests" ],
  "test_targets": [ "//base:base_unittests" ],
  "invalid_targets": []
}
```

*   **`status`**: 분석 결과 상태 문자열입니다.
    *   `"Found dependency"`: 변경된 파일이 제공된 타겟 중 일부에 영향을 줍니다.
    *   `"No dependency"`: 변경된 파일이 제공된 타겟에 아무런 영향을 주지 않습니다.
    *   `"Found dependency (all)"`: 변경 사항이 너무 광범위하여(예: 빌드 설정 파일 변경) 모든 타겟을 다시 빌드/테스트해야 합니다.
*   **`compile_targets`**: 다시 컴파일해야 할 타겟 목록입니다.
*   **`test_targets`**: 실행해야 할 테스트 타겟 목록입니다. (입력 `test_targets`의 부분집합)
*   **`invalid_targets`**: 입력에 존재하지 않는 타겟이 있을 경우 여기에 나열됩니다.

## 4. 작동 원리 (How it works)

GN은 빌드 그래프(Dependency Graph)를 역추적하여 분석을 수행합니다.

1.  **그래프 로드**: 지정된 빌드 디렉토리의 설정을 바탕으로 전체 빌드 그래프를 메모리에 로드합니다.
2.  **영향 분석**: `files` 목록에 있는 각 파일이 어떤 타겟에 속해 있는지 찾습니다.
3.  **전파 (Propagation)**: 해당 타겟을 의존하는 상위 타겟들을 추적합니다.
4.  **필터링**: 추적된 상위 타겟들 중 `test_targets`나 `additional_compile_targets`에 포함된 타겟이 있는지 확인합니다.

## 5. 활용 예시 (CI Integration)

CI 스크립트에서 다음과 같은 흐름으로 사용할 수 있습니다.

1.  Git 변경 사항 목록 추출: `git diff --name-only master...HEAD`
2.  입력 JSON 생성: 변경된 파일 목록과 전체 테스트 타겟 목록을 포함.
3.  `gn analyze` 실행.
4.  출력 JSON 파싱:
    *   `status`가 "No dependency"이면 빌드/테스트 스킵.
    *   그렇지 않으면 `compile_targets`를 빌드하고 `test_targets`만 실행.
