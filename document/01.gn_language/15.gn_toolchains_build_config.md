# Chromium GN 툴체인과 빌드 구성 (Toolchains and the Build Configuration)

GN 빌드 시스템에서 **툴체인(Toolchain)**과 **빌드 구성(Build Configuration)**은 밀접하게 연관되어 있습니다. 이 문서는 `BUILDCONFIG.gn` 파일의 역할과 툴체인이 어떻게 상호작용하여 전체 빌드 환경을 구성하는지 설명합니다.

## 1. 빌드 구성 파일 (`BUILDCONFIG.gn`)

GN 빌드가 시작되면 가장 먼저 `.gn` 파일(소스 루트에 위치)을 읽어 `buildconfig` 변수에 지정된 파일을 찾습니다. 일반적으로 `//build/config/BUILDCONFIG.gn` 경로를 사용합니다.

이 파일은 다음과 같은 중요한 역할을 수행합니다:

1.  **전역 변수 설정**: `is_debug`, `is_linux`, `target_cpu` 등 프로젝트 전반에서 사용될 OS 및 아키텍처 관련 변수를 설정합니다.
2.  **기본 툴체인 지정**: `set_default_toolchain()` 함수를 호출하여 빌드에 사용할 기본 툴체인을 설정합니다.
3.  **타겟 기본값 설정**: `set_defaults()`를 사용하여 `executable`, `source_set` 등의 타겟에 적용될 기본 `configs`를 설정합니다.

## 2. 기본 툴체인 설정 (Setting the Default Toolchain)

`BUILDCONFIG.gn` 파일은 반드시 `set_default_toolchain` 함수를 호출해야 합니다.

```gn
# BUILDCONFIG.gn 예시

# 1. 빌드 인자 선언
declare_args() {
  is_debug = true
}

# 2. 플랫폼 감지 및 설정
if (target_os == "") {
  target_os = host_os
}
if (target_cpu == "") {
  target_cpu = host_cpu
}

# 3. 기본 툴체인 설정
# 플랫폼에 맞는 툴체인 라벨을 지정합니다.
if (target_os == "linux") {
  set_default_toolchain("//build/toolchain/linux:clang_$target_cpu")
} else if (target_os == "win") {
  set_default_toolchain("//build/toolchain/win:clang_$target_cpu")
}
```

## 3. 툴체인 인자 (`toolchain_args`)

툴체인을 정의할 때 `toolchain_args` 블록을 사용하여, 해당 툴체인으로 빌드할 때 적용될 빌드 인자(Build Arguments)를 강제로 설정할 수 있습니다. 이는 크로스 컴파일이나 특정 모드(예: NaCl, Fuzzer) 빌드 시 매우 중요합니다.

```gn
# //build/toolchain/linux/BUILD.gn

toolchain("clang_x64") {
  tool("cc") { ... }
  # ...

  toolchain_args = {
    current_cpu = "x64"
    current_os = "linux"
    
    # 이 툴체인에서는 항상 특정 기능을 끔
    use_goma = false 
  }
}
```

*   **`current_cpu` / `current_os`**: 툴체인 내부에서 이 변수들을 설정하면, 해당 툴체인으로 빌드되는 타겟들은 이 값을 참조하여 조건부 컴파일을 수행할 수 있습니다.
*   **인자 오버라이드**: `declare_args`로 선언된 변수들의 값을 이 툴체인 컨텍스트 내에서만 변경할 수 있습니다.

## 4. 툴체인 전환과 빌드 흐름

GN은 기본적으로 `set_default_toolchain`으로 지정된 툴체인을 사용하여 타겟을 처리합니다. 하지만 타겟 의존성(`deps`)에 명시적으로 다른 툴체인 라벨이 지정되면 컨텍스트가 전환됩니다.

1.  **기본 빌드**: `//app:my_app` (기본 툴체인 사용, 예: `linux:clang_x64`)
2.  **툴체인 전환**: `my_app`이 `//tools:generator(//build/toolchain/linux:clang_x86)`을 의존.
3.  **재평가**: GN은 `clang_x86` 툴체인의 `toolchain_args`를 적용하여 `//tools/BUILD.gn`을 다시 로드하고 `generator` 타겟을 처리합니다. 이때 `current_cpu`는 "x86"이 됩니다.

## 5. `host_toolchain` 패턴

크로스 컴파일 환경(예: Android 빌드)에서도 컴파일러나 코드 생성기 같은 도구는 빌드 머신(Host)에서 실행되어야 합니다. 이를 위해 보통 `BUILDCONFIG.gn`에서 `host_toolchain` 변수를 정의해두고 사용합니다.

```gn
# BUILDCONFIG.gn
if (host_os == "linux") {
  host_toolchain = "//build/toolchain/linux:clang_$host_cpu"
}

# BUILD.gn
executable("my_tool") {
  # ...
}

action("run_my_tool") {
  script = "run.py"
  # my_tool을 호스트 툴체인으로 빌드하여 의존성으로 추가
  deps = [ ":my_tool($host_toolchain)" ]
}
```
