# Chromium GN 스크립트 실행 (Executing Scripts) 가이드

GN(Generate Ninja)은 빌드 과정에서 외부 스크립트(주로 Python)를 실행하는 두 가지 주요 방법을 제공합니다. 하나는 빌드 타임(Build-time)에 실행되는 `action` 타겟이고, 다른 하나는 GN 파일 생성 타임(Gen-time)에 실행되는 `exec_script` 함수입니다.

## 1. `action` 타겟 (Build-time Execution)

`action`은 Ninja가 빌드를 수행할 때 실행되는 스크립트를 정의합니다. 코드 생성, 파일 변환, 압축 등의 작업에 사용됩니다.

### 기본 구조

```gn
action("my_action") {
  script = "tools/process.py"
  sources = [ "input.data" ]
  outputs = [ "$target_gen_dir/output.cc" ]

  # 스크립트에 전달할 인자
  args = [
    "--input", rebase_path(sources[0], root_build_dir),
    "--output", rebase_path(outputs[0], root_build_dir),
  ]
}
```

### 주요 변수
*   **`script`**: 실행할 스크립트 파일 경로입니다. (Python 스크립트 권장)
*   **`inputs`** / **`sources`**: 스크립트가 읽는 입력 파일들입니다. 이 파일들이 변경되면 스크립트가 다시 실행됩니다.
*   **`outputs`**: 스크립트가 생성하는 출력 파일들입니다. 다른 타겟이 이 파일을 `sources`로 사용할 수 있습니다.
*   **`args`**: 스크립트에 전달할 커맨드 라인 인자 리스트입니다.
*   **`depfile`**: 스크립트가 `inputs`에 명시되지 않은 파일(예: import된 헤더)을 읽을 경우, 의존성 정보를 담은 파일(`.d`)을 생성하여 Ninja에게 알려줍니다.

## 2. `exec_script` 함수 (Gen-time Execution)

`exec_script`는 `gn gen` 명령이 실행되는 동안 동기적으로 스크립트를 실행합니다. 스크립트의 출력 결과를 변수에 저장하여 빌드 로직(`if` 조건문 등)에 사용할 수 있습니다.

### 기본 구조

```gn
result = exec_script("get_version.py", [], "trim string")
print("Project Version: $result")
```

### 문법
```gn
exec_script(script_path, args, input_conversion = "", file_dependencies = [])
```

*   **`input_conversion`**: 스크립트 출력을 어떻게 처리할지 지정합니다. (`"list lines"`, `"trim string"`, `"value"` 등)
*   **`file_dependencies`**: 스크립트가 의존하는 파일 목록입니다. 이 파일들이 변경되면 GN이 다시 실행됩니다.

### 주의사항 (Performance)
`exec_script`는 GN 실행 속도를 느리게 만드는 주원인이 될 수 있습니다.
*   가능하면 사용을 피하고, `action`을 사용하세요.
*   꼭 필요한 경우(예: 컴파일러 버전 확인, 시스템 설정 확인)에만 사용하세요.
*   Chromium 프로젝트에서는 `.gni` 파일에서 `exec_script` 사용을 엄격히 제한하기도 합니다.

## 3. `action_foreach` 타겟

`sources` 리스트의 **각 파일마다** 스크립트를 한 번씩 실행해야 할 때 사용합니다.

```gn
action_foreach("process_files") {
  script = "process.py"
  sources = [ "a.png", "b.png" ]
  
  # {{source}}, {{source_name_part}} 등의 치환 패턴 사용 가능
  outputs = [ "$target_gen_dir/{{source_name_part}}.cc" ]

  args = [
    "{{source}}",
    "-o", rebase_path("$target_gen_dir/{{source_name_part}}.cc", root_build_dir),
  ]
}
```

## 4. 경로 처리 (`rebase_path`)

스크립트는 빌드 디렉토리(`root_build_dir`)를 현재 작업 디렉토리(CWD)로 하여 실행됩니다. 따라서 소스 트리의 파일을 가리킬 때는 `rebase_path`를 사용하여 경로를 변환해야 합니다.

## 5. Depfile (의존성 파일)

스크립트가 입력 파일 목록(`inputs`)에 없는 파일을 내부적으로 읽는 경우(예: 파이썬 스크립트가 다른 모듈을 import 하거나, 설정 파일을 파싱하여 다른 파일을 읽는 경우), `depfile`을 사용하여 정확한 증분 빌드(Incremental Build)를 보장해야 합니다.

```gn
action("generate_code") {
  script = "generator.py"
  outputs = [ "$target_gen_dir/out.cc" ]
  depfile = "$target_gen_dir/out.d"
  # ...
}
```
