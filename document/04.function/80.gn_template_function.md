# Chromium GN Template 함수 가이드

GN(Generate Ninja)은 사용자 정의 함수(User-defined functions)를 지원하지 않는 대신, **템플릿(Template)**이라는 강력한 메커니즘을 제공합니다. 템플릿을 사용하면 반복되는 빌드 로직을 재사용 가능한 규칙으로 정의하여, 코드 중복을 줄이고 일관성을 유지할 수 있습니다.

## 1. 템플릿의 개념

템플릿은 하나의 타겟 이름과 블록을 입력받아, 내부적으로 하나 이상의 타겟(`executable`, `source_set`, `action` 등)을 생성하는 래퍼(Wrapper)입니다.

*   **코드 재사용**: 공통된 컴파일러 플래그, 의존성, 스크립트 실행 로직 등을 한곳에 정의합니다.
*   **추상화**: 복잡한 빌드 과정을 간단한 이름으로 감추어 사용자가 쉽게 쓰도록 합니다.

## 2. 템플릿 정의 (Defining Templates)

`template` 키워드를 사용하여 정의하며, 주로 `.gni` 파일에 작성하여 여러 `BUILD.gn` 파일에서 `import`하여 사용합니다.

```gn
# tools.gni
template("my_tool") {
  executable(target_name) {
    # ... 구현 내용 ...
  }
}
```

## 3. 주요 변수: `invoker`와 `target_name`

템플릿 내부에서는 두 가지 특별한 변수를 사용하여 호출자가 전달한 정보에 접근합니다.

*   **`target_name`**: 템플릿을 호출할 때 지정한 타겟의 이름입니다. (문자열)
*   **`invoker`**: 템플릿 호출 블록(`{ ... }`) 내부에서 정의된 모든 변수를 담고 있는 스코프(Scope) 객체입니다.

```gn
template("print_info") {
  print("Target name is: $target_name")
  print("Sources are: ${invoker.sources}")
}

# 사용
print_info("my_target") {
  sources = [ "a.cc", "b.cc" ]
}
```

## 4. 변수 전달 (`forward_variables_from`)

템플릿의 핵심은 호출자가 전달한 변수(`sources`, `deps`, `cflags` 등)를 내부의 실제 타겟으로 전달하는 것입니다. 이를 위해 `forward_variables_from` 함수를 사용합니다.

### 사용법
1.  **모두 전달**: `forward_variables_from(invoker, "*")`
    *   `invoker`의 모든 변수를 현재 스코프로 복사합니다.
2.  **선택 전달**: `forward_variables_from(invoker, ["sources", "deps"])`
    *   지정된 리스트의 변수만 복사합니다.
3.  **제외하고 전달**: `forward_variables_from(invoker, "*", ["visibility"])`
    *   특정 변수를 제외하고 나머지를 모두 복사합니다.

```gn
template("my_lib") {
  static_library(target_name) {
    # invoker의 모든 변수를 static_library로 전달
    forward_variables_from(invoker, "*")
    
    # 공통 설정 추가
    defines = [ "MY_LIB_IMPLEMENTATION" ]
  }
}
```

**주의**: `forward_variables_from(invoker, "*")`를 사용할 때, 이미 정의된 변수가 있다면 덮어쓰기 에러가 발생할 수 있습니다. 보통 타겟 정의의 가장 윗부분에 작성합니다.

## 5. 다중 타겟 생성 (Defining Multiple Targets)

하나의 템플릿이 여러 개의 타겟을 생성할 수도 있습니다. 예를 들어, 코드를 생성하는 `action` 타겟과 그것을 컴파일하는 `source_set`을 묶을 수 있습니다.

이때 내부 타겟들의 이름이 충돌하지 않도록 주의해야 합니다.

```gn
template("code_gen_lib") {
  action_name = "${target_name}_gen"
  
  # 1. 코드 생성 타겟
  action(action_name) {
    script = "gen.py"
    outputs = [ "$target_gen_dir/out.cc" ]
    # ...
  }

  # 2. 컴파일 타겟 (메인 타겟)
  source_set(target_name) {
    sources = [ "$target_gen_dir/out.cc" ]
    deps = [ ":$action_name" ] # 생성 타겟 의존
    forward_variables_from(invoker, [ "visibility", "testonly" ])
  }
}
```

## 6. 모범 사례 (Best Practices)

1.  **`testonly` 전달**: 템플릿이 테스트용 타겟을 생성하거나 의존한다면, `invoker`의 `testonly` 변수를 반드시 전달해야 합니다. `forward_variables_from(invoker, "*")`를 쓰면 자동 처리되지만, 수동으로 할 경우 `if (defined(invoker.testonly)) { testonly = invoker.testonly }` 처리가 필요합니다.
2.  **`visibility` 관리**: 내부적으로만 사용되는 보조 타겟(위 예제의 `action`)은 `visibility`를 제한하여 외부에서 직접 접근하지 못하게 하는 것이 좋습니다.
3.  **이름 충돌 방지**: 템플릿 내부 변수는 외부로 유출되지 않지만, 템플릿 이름 자체는 전역적이므로 프로젝트 접두어 등을 사용하는 것이 좋습니다.
